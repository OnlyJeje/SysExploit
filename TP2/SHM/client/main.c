#include "include.h"

int main(int ac, char **av)
{  
  int client_fd;
  FILE *fd;
  char *buffer = NULL;
  char *shm;
  char c;
  size_t sizefile;
  int i = 0;
  key_t key = 123;

  off_t offset = 0; 
  if (ac < 2)
    {
      printf("%s\n", "Veuillez entrer le nom d'un fichier.");
      return (-1);
    }
  
  fd = fopen(av[1], "r");
  sizefile = sizeof(fseek(fd, 0L, SEEK_SET));

  /* Assignation segment mémoire */
  client_fd = shmget(key, sizefile, IPC_CREAT);
  if (client_fd == -1)
    {
        printf("%s\n", "ERROR: shmget failed, ABORT");
      return (-1);
    
    }

  /* Segment mémoire attaché */
  shm = shmat(client_fd, NULL, 0);
  if (shm == (void *)-1)
    {
      printf("%s\n", "ERROR: shmat failed, ABORT");
      return (-1);
    }
  
  buffer = malloc(sizefile);  

  /* Sauvegarde du fichier dans le buffer */
  while ((c = fgetc(fd)) != EOF)
    {
      buffer[i++] = c;
    }
  
  /* Ecriture du buffer dans le segment mémoire */
  sprintf(shm,"%s", buffer);
  shmdt(shm);
}
